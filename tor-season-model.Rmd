---
title: "Seasonal tornado model"
output: html_document
date: "2022-12-03"
---

Download the data and put it into the folder called `data`

```{r}
loc <- "http://www.spc.noaa.gov/gis/svrgis/zipped/1950-2021-torn-aspath.zip"

download.file(url = loc,
              destfile = here::here("data", "1950-2021-torn-aspath.zip"))

unzip(zipfile = here::here("data", "1950-2021-torn-aspath.zip"), 
      exdir = here::here("data"))
```

Get the data into your R session

```{r}
Torn.sf <- sf::st_read(dsn = here::here("data", "1950-2021-torn-aspath"), 
                       layer = "1950-2021-torn-aspath") 

Torn.sf |>
  str()
```

Filter and augment the data frame. Make sure to center the variables

```{r}
Counts.df <- Torn.sf |>
  sf::st_drop_geometry() |>
  dplyr::filter(yr >= 1992,
                mag >= 0) |>
  dplyr::mutate(Date = lubridate::as_date(date),
                Month = lubridate::month(Date),
                Year = lubridate::year(Date),
                DoY = lubridate::yday(Date),
                YearC = Year - 2006,
                MonthC = Month - 6,
                DoYC = DoY - 182) |>
  dplyr::group_by(YearC, DoYC) |>
  dplyr::summarise(nT = dplyr::n())
```

Model

```{r}
f <- nT ~ YearC * DoYC

fit0 <- brms::brm(f, data = Counts.df, 
                  family = negbinomial(link = "log", 
                                       link_shape = "log"))

pp_check(fit0)
```

Model the cumulative distribution directly (see Example 3: Insured loss payments https://cran.microsoft.com/snapshot/2022-02-20/web/packages/brms/vignettes/brms_multilevel.pdf)

```{r}
Counts.df <- Torn.sf |>
  sf::st_drop_geometry() |>
  dplyr::filter(yr >= 1992,
                mag >= 0) |>
  dplyr::mutate(Date = lubridate::as_date(date),
                Month = lubridate::month(Date),
                Year = lubridate::year(Date),
                D = lubridate::yday(Date),
                YearC = Year - 2006,
                DF = as.factor(D)) |>
  dplyr::group_by(Year, D, .drop = FALSE) |>
  dplyr::summarise(nT = dplyr::n()) |>
  dplyr::group_by(Year) |>
  dplyr::mutate(C = cumsum(nT),
                nT = nT,
                TY = dplyr::last(C))
```

Here I model the cumulative number of tornadoes starting on January 1st for different years. The model is:

$$
\hbox{C}_{Y,D} \sim N(\mu_{Y,D}, \sigma) \\
\mu_{Y,D} = \hbox{T}_{Y} \Big(1 - \exp\Big(-\Big(\frac{D}{\theta}\Big)^\omega \Big) \Big)
$$

The cumulative number of tornadoes C will increase over time D. Further, $\hbox{T}_{Y}$ is the (to be estimated) total number of tornadoes each year. It constitutes a parameter in the framework along with the parameters θ and ω, which are responsible for the increase in tornado activity and are assumed to be the same across years.

The corresponding {brms} model is as follows.

```{r}
library(brms)

nlform <- bf( C ~ TY * (1 - exp(-(D / theta)^omega)),
             TY ~ 1 + (1 | Year), 
             omega ~ 1, 
             theta ~ 1, 
             nl = TRUE)

nlprior <- c(prior(normal(1000, 1000), 
                   nlpar = "TY"),
             prior(normal(1, 2), 
                   nlpar = "omega"),
             prior(normal(45, 10), 
                   nlpar = "theta"))
```

Fit the model

```{r}
fit0 <- brm(formula = nlform, 
            data = Counts.df, 
            family = gaussian(),
            prior = nlprior, 
            control = list(adapt_delta = .9))
```

```{r}
conditional_effects(fit0)
```

We can also visualize the cumulative number of tornadoes separately for each year.

```{r}

conditions <- data.frame(Year = unique(Counts.df$Year))
rownames(conditions) <- unique(Counts.df$Year)

conditions <- conditions |>
  dplyr::filter(Year >= 2012)

me_year <- conditional_effects(fit0, 
                               conditions = conditions,
                               re_formula = NULL, 
                               method = "predict")

plot(me_year, ncol = 5, points = TRUE)
```